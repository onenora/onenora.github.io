# 服务器优化之一:开启BBR


## 1. 传说中的 BBR

我相信，你在搜索各种科学上网技术的时候，肯定不止一次的听过 bbr 这个东西，在各种博客添油加醋之下，让人觉得它神乎其神。更有 bbrplus, bbr2, 魔改 bbr 等一大堆衍生品。仿佛神油一般，用了就能野鸡线路变专线。

那么，这东西究竟是什么？它有没有用？又该用哪一个版本呢？

## 2. 实际的 BBR

**BBR** = **B**ottleneck **B**andwidth and **R**ound-trip propagation time，是一种 TCP 的**拥塞控制算法**。简单粗暴的理解就是**数据流量的交通管理** ：当公路不再塞车的时候，每辆车自然就能保持较快的车速了。

那么它有没有用呢？一般而言，有 BBR 和 没有 BBR 会有可以感知的差别（速度、稳定性、延迟方面都会有一些改善），所以 **【非常建议开启 BBR】**。

但开启之后，BBR 在 4.x 和 5.x 之间的差异往往比较微妙、见仁见智，造成体验差别的决定性因素仍然是线路质量。所以 **【不必纠结版本、不必盲目追新、跟随你的发行版更新内核即可】**

## 3. bbrplus, bbr2, 魔改 bbr 和其他各种听起来就酷炫的版本是不是更好？

一句话：**不是！不要用这些！这些都为了吸引眼球乱起的名字！**

BBR 的更新和发布，都是跟随 Linux 的内核（Kernel）进行的。换言之，只要你用的是比较新的内核，就自然会使用到新版 BBR。

而这些名字看起来很酷炫的东西，说白了就是仍未正式发布的、尚在测试阶段的内核及其对应的 BBR 版本。这些脚本也仅仅就是通过下载预览版的内核（甚至第三方魔改内核）来率先开启而已。

内核的稳定是一台服务器稳定运行的基石。**【BBR 测试版带来的细微性能差异绝对不值得更换不稳定的内核。】** 请选择你所在的 Linux 发行版所支持的最新内核，这样可以最大限度的保持服务器的长期稳定和兼容。

> 注意
> 所谓魔改 bbr 的【领先】是有非常强的时效性的。比如很多 bbrplus 脚本，因为几年来都没有更新，到现在还会把你的内核换成 4.19，要知道现在稳定如 Debian 已经是 5.9 的时代了，那么这个脚本放在 2018 年 1 月也许领先了一点，到 2018 年 10 月 4.19 正发布时就已经失去了意义，放在现在甚至可以说是完完全全的【降级】和【劣化】

## 4. fq, fq_codel, fq_pie, cake 和其他算法哪个好？

一句话：**看不懂的话，请保持 fq，足够、且不会劣化你的线路**

## 5. 锐速、Finalspeed、LotServer 和其他“加速工具”

一句话：**不要用这些！把他们丢进历史的垃圾桶吧！**

它能解决的也只有丢包率的问题。不太准确的比喻，就是本来你用一辆车送你的货，有时候车半路就坏了（丢包），用了这些以后，你直接派出 3 份一样的货，让三辆车同时送，只要有一辆没坏就能送到。马路上都是你的车，自然就能把别人挤下去。但可想而知，你挤别人的时候，别人也会来挤你，而整个机房的出口道路一共就那么宽，最终势必就变成集体大堵车了。

> 说明
> 它们的原理不是算法优化、不是提速、大多数是简单粗暴的**多倍发包**。对于【丢包率非常高】的差线路可能有一点作用，但【对丢包率低的好线路没有任何优化作用，反而会成倍的消耗你的流量】，进而造成服务器和你的邻居不必要的压力。

如果你的线路真的丢包率奇高，真正靠谱的解决方案是【换线路】。

## 6. 啰嗦了这么多
>就是因为围绕 BBR 忽悠小白的错误概念和坑人脚本实在是太多了。我希望你们现在对 BBR 有了相对清晰的理解。接下来，我们就动手安装最新的 Debian 内核并开启 BBR 吧！（真的很简单）

### 6.1 给 Debian 10 添加官方 backports 源，获取更新的软件库

```bash
sudo nano /etc/apt/sources.list
```

> 说明
> 本文以 Debian 10 为例，所以使用 /etc/apt/sources.list 仍无问题，但如果你并不是根据本文从头开始，或者使用了其他 Linux 发行版，那么建议你建立 /etc/apt/sources.list.d/ 文件夹，并在这个文件夹内建立自己的配置文件，形如 /etc/apt/sources.list.d/vpsadmin.list ，以此保证兼容性，也可避免默认文件在不可预见的情况下被覆盖而导致配置丢失。

### 6.2 然后把下面这一条加在最后，并保存退出。

```bash
deb http://deb.debian.org/debian buster-backports main
```

### 6.3 刷新软件库并查询

 Debian 官方的最新版内核并安装。请务必安装你的 VPS 对应的版本（本文以比较常见的【amd64】为例）。

```bash
sudo apt update && sudo apt -t buster-backports install linux-image-amd64
```

> 注意
> 如果你的 VPS 支持，可以尝试【云服务器专用内核】linux-image-cloud-amd64，优点就是精简、资源占用低，缺点嘛是有同学反馈不支持的系统强行安装会导致无法开机（Kernel 无法识别）。

为了避免无法识别的悲剧，请确保：

- 尝试前做一个系统快照，或者
- 你有 vnc 可以救场（并且你知道怎么用）

### 6.4. 修改 kernel 参数配置文件 sysctl.conf 并指定开启 BBR

```bash
sudo nano /etc/sysctl.conf
```

> 说明
> 本文以 Debian 10 为例，所以使用 /etc/sysctl.conf 仍无问题，但如果你并不是跟着本文从头开始，或者使用了其他 Linux 发行版，那么建议你建立 /etc/sysctl.d/ 文件夹，并在这个文件夹内建立自己的配置文件，形如 /etc/sysctl.d/vpsadmin.conf，以此保证兼容性，因为部分发行版在 systemd 207 版本之后便不再从 /etc/sysctl.conf 读取参数。使用自定义配置文件也可避免默认文件在不可预见的情况下被覆盖而导致配置丢失。

### 6.5 把下面的内容添加进去

```bash
net.core.default\_qdisc=fq
net.ipv4.tcp\_congestion\_control=bbr
```

### 6.6 重启 VPS、使内核更新和 BBR 设置都生效

```bash
sudo reboot
```


## 8. 确认 BBR 开启

如果你想确认 BBR 是否正确开启，可以使用下面的命令：

`lsmod | grep bbr`

此时应该返回这样的结果：

```bash
tcp\_bbr
```

如果你想确认 fq 算法是否正确开启，可以使用下面的命令：

`lsmod | grep fq`

此时应该返回这样的结果：

```bash
sch\_fq
```


